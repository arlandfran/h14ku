# Deployment

This application was deployed on Heroku using Gunicorn as the Python web server. The Flask app serves the dist bundle generated by Routify's build process and also contains the API endpoints for the backend. Here are the deployment steps:

**Pre-requisites:** Heroku account, MongoDB account

## Setting up Heroku

Create your Heroku account [here](https://signup.heroku.com/login).

Start off by cloning this project to your machine:

```Shell
git clone http://github.com/arlandfran/h14ku.git
```

Next open a terminal and install Heroku CLI. Installation steps for each platform can be found in the official documentation [here](https://devcenter.heroku.com/articles/heroku-cli).

Once you've installed Heroku CLI run `heroku login` and follow the prompts.

Navigate to the project directory if you haven't already `cd h14ku` and run `heroku create my-app-name`. Be sure to pass in your own unique app name such as "h14ku-test" as h14ku is already taken.

```Shell
$ heroku create h14ku-test
Creating â¬¢ h14ku-test... done
https://h14ku-test.herokuapp.com/ | https://git.heroku.com/h14ku-test.git
```

> By default the app is created in the US region, if you want to create the app in Europe provide the --region flag in the `heroku create` command.
>
> ```Shell
> heroku create my-app-name --region eu
> ```

Once your Heroku app has been created, a git remote called `heroku` should also have been created and associated with your local git repository. You can confirm this by running `git remote -v`.

```Shell
$ git remote -v
heroku  https://git.heroku.com/h14ku-test.git (fetch)
heroku  https://git.heroku.com/h14ku-test.git (push)
origin  http://github.com/arlandfran/h14ku.git (fetch)
origin  http://github.com/arlandfran/h14ku.git (push)
```

> Note: If you would like to setup automatic deployment on Heroku, you will need to have your own Github repository of this project, in which case you will need to fork this project and then connect that forked repository to Heroku.

```Shell
$ git remote -v
heroku  https://git.heroku.com/h14ku-test.git (fetch)
heroku  https://git.heroku.com/h14ku-test.git (push)
origin  http://github.com/your-github-username/h14ku.git (fetch)
origin  http://github.com/your-github-username/h14ku.git (push)
```

At this stage you should be able to deploy your application to Heroku using `git push heroku main` but because this app uses Svelte for the frontend, you'll need to configure a Node.js buildpack as well as a Python buildpack for the app to build correctly on Heroku.

First you'll need to add the primary buildpack for this application which is the Python buildpack as your application will be served from Gunicorn.

```Shell
heroku buildpacks:set heroku/python
```

Then you can add the Node.js buildpack so that Heroku can properly install the project dependencies found in the package.json file. This command will insert the buildpack to the top of the buildpack execution order, which is what you want as you'll need the Node.js buildpack to generate the /dist bundle first for Flask to serve.

```Shell
heroku buildpacks:add --index 1 heroku/nodejs
```

You can run the `heroku buildpack` command to verify that the buildpacks are in the correct order.

```Shell
$ heroku buildpacks
=== h14ku-test Buildpack URLs
1. heroku/nodejs
2. heroku/python
```

Now that your buildpacks have been configured correctly you can now setup your MongoDB database and connect it to Heroku.

## Setting up MongoDB

Create your MongoDB account [here](https://account.mongodb.com/account/register).

Once you've created your account follow the prompts to create an organization and project.

You should now be able to create a cluster for your project, go ahead an create a free tier cluster.

1. Select a cloud provider of your choice and choose the region closest to your Heroku application.

2. Select the `M0 Sandbox` Cluster Tier.

3. Give your cluster a name. Example: h14ku-eu-west

Once your cluster has been provisioned, navigate to the _Database Access_ tab and add a new database user. When you have done that navigate to the _Network Access_ tab and a new IP address `0.0.0.0/0`. This configures your cluster to accept access from any IP address.

> Ideally in a production environment you will want to explicity set the exact IP address your application will be hosted on to restrict access.

Go back to the _Database_ tab and select _Connect_ next to the cluster name and choose _Connect your application_. Proceed to choose Python as the driver and select version 3.6 or later.

You should also see your connection string underneath:

`mongodb+srv://<user>:<password>@<cluster>.mongodb.net/myFirstDatabase?retryWrites=true&w=majority`

Copy the connection string and go back to the Heroku CLI terminal and configure the Heroku config vars to properly connect your MongoDB database.

```Shell
heroku config:set MONGO_URI="YOUR_CONNECTION_STRING"
```

> Remember to update the password and myFirstDatabase name fields in the connection string and paste it **inside** the double quotes.

Now your application can securely access the MONGO_URI string and we can finally deploy it to Heroku.

```Shell
git commit -am "initial deploy"
git push heroku main
```

Once your app has deployed you can run `heroku ps:scale web=1` command. This will start up 1 free dyno for your app to run on and you can visit your app with `heroku open`.

## Running locally

**Pre-requisites:** Node, Python

To run this application locally clone the Github repository and install the project dependencies for Svelte.

```Shell
git clone http://github.com/arlandfran/h14ku.git
cd h14ku
npm install
```

Next create a virtual environment for the Python dependencies and install them in the virtual environment.

```Shell
cd api
python -m venv venv
. venv/bin/activate
cd ..
pip install -r requirements.txt
```

> venv\Scripts\activate.bat for Windows

`npm run api` to start the Flask server and then open another terminal window and `npm run dev` to start the application. Visit `http://localhost:5000` to see the app running locally.
